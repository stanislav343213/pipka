<!doctype html>
<meta charset="utf-8" />
<title>üì±–£–∑–Ω–∞–π  —Ç–µ–ª–µ—Ñ–æ–Ωüì±</title>

<!-- TFJS + TeachableMachine -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

<style>
  :root{
    --accent:#E31E24;
    --bg:#f7f7f9;
    --text:#1a1a1a;
    --muted:#6b7280;
    --card:#ffffff;
    --bar:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  /* ====== –®–∞–ø–∫–∞ ====== */
  header{
    background:#fff; color:#fff; padding:28px 0;
    margin-bottom:18px;
  }
  header .container{
    max-width:1200px; margin:0 auto; padding:0 16px;
    display:flex; align-items:center; gap:16px
  }
  header img{
    height:clamp(90px, 10vw, 160px);
    width:auto; display:block;
  }
  header h1{margin:0; font-weight:800; letter-spacing:.02em; line-height:1.1}
  header h1 small{display:block; color:#FF5733; font-weight:600; font-size:16px}
  
  /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ "–£–∑–Ω–∞–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" */
  header h1 .main-title{
    color: #736ee3; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç */
  }

  /* ====== –ö–æ–Ω—Ç–µ–Ω—Ç ====== */
  .container{max-width:1200px; margin:0 auto; padding:24px 16px 48px}
  .grid{display:grid; grid-template-columns:360px 1fr; gap:22px}
  .card{
    background:var(--card); border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,.08);
    padding:18px; overflow:hidden;    /* <-- –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ª–µ–∑–µ—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã */
  }
  .card h3{margin:0 0 12px; font-size:18px}
  .muted{color:var(--muted)}

  .btn{
    display:inline-flex; align-items:center; gap:8px;
    background:var(--accent); color:#fff; border:0;
    padding:10px 14px; border-radius:10px; cursor:pointer;
    font-weight:700; letter-spacing:.02em;
    transition: background-color 0.3s ease;
    font-family: inherit; /* –ù–∞—Å–ª–µ–¥—É–µ—Ç —à—Ä–∏—Ñ—Ç –æ—Ç body */
    font-size: 16px; /* –Ø–≤–Ω–æ –∑–∞–¥–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
  }
  /* –ì–æ–ª—É–±–æ–π —Ü–≤–µ—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É" */
  .btn.camera{
    background: #0ac2e0; /* –ì–æ–ª—É–±–æ–π —Ü–≤–µ—Ç */
  }
  .btn.camera:hover{
    background: #1C86EE; /* –¢–µ–º–Ω–µ–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
  }
  .btn.secondary{
    background:#111;
    font-weight:700; /* –¢–∞–∫–æ–π –∂–µ –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –∫–∞–∫ —É –∫–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã */
    letter-spacing:.02em; /* –¢–∞–∫–æ–π –∂–µ –º–µ–∂–±—É–∫–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª */
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}

  .controls{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px}
  input[type="file"]{display:inline-block}

  #preview, #cam canvas{
    width:100%; height:360px; object-fit:contain; background:#000;
    border-radius:12px;
  }
  #cam canvas{display:block}

  /* ====== –ë–ª–æ–∫ –ø–æ—Ä–æ–≥–∞ –≤ —Ä–∞–º–∫–µ ====== */
  .hint-box{
    margin-top:12px;
    background:#f8fafc;
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:12px 14px;
  }
  .hint-box .row{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  .hint-box .label{min-width:140px; font-weight:700}
  .hint-box input[type="range"]{width:200px}
  .hint-box small{display:block; margin-top:8px; color:var(--muted); line-height:1.35}
  .hint-box b{color:#111}

  /* ====== –í–µ—Ä–¥–∏–∫—Ç –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ ====== */
  .verdict{
    margin:8px 0 14px; padding:10px 12px; border-radius:12px;
    background:#f8fafc; border:1px dashed #e5e7eb;
  }
  .verdict b{color:#111}
  .verdict .other{color:#ef4444}

  .row-prob{display:flex; align-items:center; gap:10px; margin:6px 0}
  .row-prob .label{width:120px; font-weight:600}
  .row-prob .bar{position:relative; flex:1; height:16px; background:var(--bar);
                border-radius:999px; overflow:hidden}
  .row-prob .bar > span{position:absolute; inset:0 auto 0 0; width:0%;
                       background:linear-gradient(90deg, var(--accent), #ff7d85)}
  .row-prob .val{width:64px; text-align:right; font-variant-numeric:tabular-nums}
</style>

<header>
  <div class="container">
    <img src="./logo.png?v=1" alt="–õ–æ–≥–æ—Ç–∏–ø —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
    <h1>
      <span class="main-title">–£–∑–Ω–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω</span>
      <small>–ú–æ–¥–µ–ª—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞</small>
    </h1>
  </div>
</header>

<div class="container">
  <div class="grid">

    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="card">
      <h3>–í–≤–æ–¥</h3>
      <div class="controls">
        <button id="btn" class="btn camera">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
        <label class="btn secondary" for="file">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
        <input id="file" type="file" accept="image/*" style="display:none">
      </div>

      <div id="cam"></div>
      <img id="preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" style="display:none">

      <!-- –ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ -->
      <div class="hint-box">
        <div class="row">
          <span class="label">–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:</span>
          <input id="th" type="range" min="0.30" max="0.95" step="0.01" value="0.65">
          <b id="thVal">0.65</b>
        </div>
        <small>–ï—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è ‚Äî –∏—Ç–æ–≥–æ–º –±—É–¥–µ—Ç <b>¬´–î—Ä—É–≥–æ–µ¬ª</b>.</small>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="card">
      <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
      <div id="status" class="muted">–ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å‚Ä¶</div>

      <div class="verdict" id="verdict" style="display:none"></div>
      <div id="probs"></div>
    </div>

  </div>
</div>

<script>
/* ==== –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ==== */
let THRESHOLD = 0.65;          // –ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (–º–µ–Ω—è–µ—Ç—Å—è —Å–ª–∞–π–¥–µ—Ä–æ–º)
const MARGIN_MIN = 0.10;       // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑—Ä—ã–≤ Top1‚ÄìTop2 (–≤ –¥–æ–ª—è—Ö)
const ENTROPY_MAX = 1.2;       // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–Ω—Ç—Ä–æ–ø–∏—è –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

document.getElementById('thVal').textContent = THRESHOLD.toFixed(2);
document.getElementById('th').addEventListener('input', e => {
  THRESHOLD = Number(e.target.value);
  document.getElementById('thVal').textContent = THRESHOLD.toFixed(2);
});

/* ==== —ç–ª–µ–º–µ–Ω—Ç—ã ==== */
const btn = document.getElementById('btn');
const file = document.getElementById('file');
const camWrap = document.getElementById('cam');
const preview = document.getElementById('preview');
const statusEl = document.getElementById('status');
const verdictEl = document.getElementById('verdict');
const probsEl = document.getElementById('probs');

/* ==== –º–æ–¥–µ–ª—å/–∫–∞–º–µ—Ä–∞ ==== */
let model, webcam, raf;
const v = 'v=1'; // –∞–Ω—Ç–∏-–∫—ç—à –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–∏

(async () => {
  try {
    model = await tmImage.load(`./model.json?${v}`, `./metadata.json?${v}`);
    statusEl.textContent = '–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–∞–º–µ—Ä—É.';
  } catch (e) {
    statusEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ (—Å–º. Console).';
    console.error('LOAD ERROR:', e);
  }
})();

/* –ü–æ–ª–æ—Å–∫–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π */
function renderBars(preds) {
  probsEl.innerHTML = '';
  preds.forEach(p => {
    const row = document.createElement('div'); row.className = 'row-prob';
    const label = document.createElement('div'); label.className = 'label'; label.textContent = p.className;
    const bar = document.createElement('div'); bar.className = 'bar';
    const span = document.createElement('span'); span.style.width = `${(p.probability*100).toFixed(1)}%`;
    bar.appendChild(span);
    const val = document.createElement('div'); val.className = 'val';
    val.textContent = `${(p.probability*100).toFixed(1)}%`;
    row.append(label, bar, val);
    probsEl.appendChild(row);
  });
}

/* –ò—Ç–æ–≥: –ø–æ—Ä–æ–≥ + —Ä–∞–∑—Ä—ã–≤ + —ç–Ω—Ç—Ä–æ–ø–∏—è */
function renderVerdict(preds) {
  const sorted = [...preds].sort((a,b)=>b.probability-a.probability);
  const top1 = sorted[0];
  const top2 = sorted[1] || { probability: 0 };

  const belowThreshold = top1.probability < THRESHOLD;
  const margin = top1.probability - top2.probability;
  const smallMargin = margin < 0.10;

  let H = 0;
  for (const p of preds) if (p.probability>0) H += -p.probability*Math.log(p.probability);
  const highEntropy = H > ENTROPY_MAX;

  verdictEl.style.display = 'block';

  if (belowThreshold || smallMargin || highEntropy) {
    const reasons = [];
    if (belowThreshold) reasons.push(`Top-1 –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞ ${Math.round(THRESHOLD*100)}%`);
    if (smallMargin)   reasons.push(`—Ä–∞–∑—Ä—ã–≤ Top-1/Top-2 –ª–∏—à—å ${(margin*100).toFixed(1)} –ø.–ø.`);
    if (highEntropy)   reasons.push(`–≤—ã—Å–æ–∫–∞—è —ç–Ω—Ç—Ä–æ–ø–∏—è ${H.toFixed(2)}`);

    verdictEl.innerHTML = `–ò—Ç–æ–≥: <b class="other">–î—Ä—É–≥–æ–µ</b> <span class="muted">(${reasons.join(', ')})</span>`;
  } else {
    verdictEl.innerHTML =
      `–ò—Ç–æ–≥: <b>${top1.className}</b> ‚Äî ${(top1.probability*100).toFixed(1)}% <span class="muted">(—Ä–∞–∑—Ä—ã–≤ —Å Top-2: ${(margin*100).toFixed(1)} –ø.–ø.)</span>`;
  }
}

/* –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É (img/canvas) */
async function predictOn(el) {
  if (!model) return;
  try {
    const preds = await model.predict(el);
    statusEl.textContent = '';
    renderVerdict(preds);
    renderBars(preds);
  } catch (e) {
    statusEl.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è (—Å–º. Console).';
    console.error('PREDICT ERROR:', e);
  }
}

/* –§–∞–π–ª */
file.onchange = e => {
  const f = e.target.files?.[0]; if (!f) return;
  const url = URL.createObjectURL(f);

  if (raf) cancelAnimationFrame(raf);
  if (webcam) webcam.stop();

  camWrap.innerHTML = '';
  preview.style.display = 'block';
  preview.src = url;

  preview.onload = async () => { await predictOn(preview); URL.revokeObjectURL(url); };
  preview.onerror = () => { statusEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.'; URL.revokeObjectURL(url); };
};

/* –ö–∞–º–µ—Ä–∞ */
btn.onclick = async () => {
  if (!model) return;
  try {
    if (raf) cancelAnimationFrame(raf);
    if (webcam) webcam.stop();

    preview.style.display = 'none';
    webcam = new tmImage.Webcam(224,224,true);
    await webcam.setup(); await webcam.play();
    camWrap.innerHTML = ''; camWrap.appendChild(webcam.canvas);
    loop();
  } catch (e) {
    statusEl.textContent = '–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ' + e;
    console.error(e);
  }
};

async function loop() {
  webcam.update();
  await predictOn(webcam.canvas);
  raf = requestAnimationFrame(loop);
}

addEventListener('beforeunload', () => {
  if (raf) cancelAnimationFrame(raf);
  if (webcam) webcam.stop();
});

</script>
